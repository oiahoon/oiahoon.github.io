---
import { getCollection } from 'astro:content';
import SpotlightLayout from '../layouts/SpotlightLayout.astro';
import { getPreviewImage } from '../utils/extractFirstImage';

const posts = await getCollection('posts', ({ data }) => !data.draft && data.type !== 'photography');

const sortedPosts = posts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

const totalTags = new Set(sortedPosts.flatMap((post) => post.data.tags || [])).size;
---

<SpotlightLayout
  title="文章 | Joey's Notes"
  description="技术文章与工程思考，聚焦可落地实践与问题复盘。"
  lang="zh"
>
  <section class="sm:px-8 mt-12 sm:mt-16">
    <div class="mx-auto w-full max-w-7xl lg:px-8">
      <div class="relative px-4 sm:px-8 lg:px-12">
        <div class="mx-auto max-w-2xl lg:max-w-5xl">
          <div class="rounded-3xl border border-zinc-200/80 bg-gradient-to-br from-white via-zinc-50 to-zinc-100/60 p-7 sm:p-10 dark:border-zinc-700/50 dark:from-zinc-900 dark:via-zinc-900 dark:to-zinc-800">
            <p class="text-xs font-semibold uppercase tracking-[0.18em] text-zinc-500 dark:text-zinc-400">Articles</p>
            <h1 class="mt-4 text-3xl font-bold tracking-tight text-zinc-900 sm:text-5xl dark:text-zinc-100">技术文章与思考</h1>
            <p class="mt-4 max-w-2xl text-base leading-7 text-zinc-600 dark:text-zinc-300">以排障过程、架构实践和工具经验为主。尽量减少概念堆叠，优先提供可直接复用的内容。</p>
            <div class="mt-6 flex flex-wrap gap-3 text-sm">
              <span class="rounded-full bg-zinc-100 px-3 py-1 font-medium text-zinc-700 dark:bg-zinc-800 dark:text-zinc-300">{sortedPosts.length} 篇文章</span>
              <span class="rounded-full bg-zinc-100 px-3 py-1 font-medium text-zinc-700 dark:bg-zinc-800 dark:text-zinc-300">{totalTags} 个标签</span>
              <a href="/tags/" class="rounded-full bg-orange-100 px-3 py-1 font-medium text-orange-700 transition hover:bg-orange-200 dark:bg-orange-500/15 dark:text-orange-300 dark:hover:bg-orange-500/25">浏览标签</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="sm:px-8 mt-12 sm:mt-14">
    <div class="mx-auto w-full max-w-7xl lg:px-8">
      <div class="relative px-4 sm:px-8 lg:px-12">
        <div class="mx-auto max-w-2xl lg:max-w-5xl">
          <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            {sortedPosts.map((post) => {
              const previewImage = getPreviewImage(post);
              const summary = post.data.description || post.data.subtitle || '点击查看完整内容。';

              return (
                <article class="group overflow-hidden rounded-2xl border border-zinc-200/80 bg-white transition hover:-translate-y-0.5 hover:border-zinc-300 hover:shadow-sm dark:border-zinc-700 dark:bg-zinc-900 dark:hover:border-zinc-500">
                  {previewImage && (
                    <a href={`/posts/${post.slug}/`} class="block">
                      <img
                        src={previewImage}
                        alt={post.data.title || '文章预览图'}
                        class="aspect-[16/9] w-full object-cover"
                        loading="lazy"
                        decoding="async"
                      />
                    </a>
                  )}

                  <div class="p-5">
                    <time class="text-xs text-zinc-500 dark:text-zinc-400" datetime={post.data.date.toISOString()}>
                      {post.data.date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                      })}
                    </time>

                    <h2 class="mt-2 text-lg font-semibold leading-7 text-zinc-900 dark:text-zinc-100">
                      <a href={`/posts/${post.slug}/`} class="transition group-hover:text-orange-600 dark:group-hover:text-orange-300">{post.data.title}</a>
                    </h2>

                    <p class="mt-2 text-sm leading-6 text-zinc-600 dark:text-zinc-400">{summary}</p>

                    {post.data.tags.length > 0 && (
                      <div class="mt-4 flex flex-wrap gap-2">
                        {post.data.tags.slice(0, 3).map((tag) => (
                          <span class="rounded-full bg-zinc-100 px-2.5 py-1 text-xs font-medium text-zinc-700 dark:bg-zinc-800 dark:text-zinc-300">{tag}</span>
                        ))}
                      </div>
                    )}

                    <a href={`/posts/${post.slug}/`} class="mt-4 inline-flex items-center text-sm font-semibold text-orange-600 dark:text-orange-300">
                      继续阅读
                      <span class="ml-1">→</span>
                    </a>
                  </div>
                </article>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  </section>
</SpotlightLayout>
