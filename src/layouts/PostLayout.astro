---
import SpotlightLayout from './SpotlightLayout.astro';
import PhotographyLayout from './PhotographyLayout.astro';
import { generateBlogPostStructuredData } from '../utils/seo';

export interface Props {
  title: string;
  subtitle?: string;
  author: string;
  date: Date;
  tags: string[];
  header_img?: string;
  description?: string;
  lang: 'zh' | 'en';
  type?: 'article' | 'photography';
  gallery?: Array<{
    src: string;
    alt?: string;
    caption?: string;
    width?: number;
    height?: number;
  }>;
  camera?: {
    model?: string;
    lens?: string;
    settings?: string;
  };
  location?: string;
  publishedDate?: string;
}

const {
  title,
  subtitle,
  author,
  date,
  tags,
  header_img,
  description,
  lang,
  type = 'article',
  gallery,
  camera,
  location,
  publishedDate,
} = Astro.props;

const postUrl = new URL(Astro.url.pathname, Astro.site).toString();
const previewImage = header_img || (type === 'photography' && gallery?.[0]?.src);
const structuredData = generateBlogPostStructuredData({
  title,
  description: description || subtitle,
  author,
  date,
  image: previewImage,
  url: postUrl,
  tags,
  type,
});
---

{type === 'photography' ? (
  <PhotographyLayout
    title={title}
    subtitle={subtitle}
    author={author}
    date={date}
    tags={tags}
    header_img={header_img}
    description={description}
    lang={lang}
    gallery={gallery}
    camera={camera}
    location={location}
    publishedDate={publishedDate}
  >
    <slot />
  </PhotographyLayout>
) : (
  <SpotlightLayout
    title={`${title} | Joey's Notes`}
    description={description || subtitle || title}
    image={previewImage || undefined}
    lang={lang}
    structuredData={structuredData}
  >
    <article class="sm:px-8 mt-14 sm:mt-20">
      <div class="mx-auto w-full max-w-7xl lg:px-8">
        <div class="relative px-4 sm:px-8 lg:px-12">
          <div class="mx-auto max-w-3xl">
            <a
              href="/articles/"
              class="inline-flex items-center rounded-full border border-zinc-300 bg-white px-3 py-1.5 text-sm font-medium text-zinc-600 transition hover:border-zinc-400 hover:text-zinc-900 dark:border-zinc-700 dark:bg-zinc-900 dark:text-zinc-300 dark:hover:border-zinc-500 dark:hover:text-zinc-100"
            >
              <span class="mr-1">←</span>
              返回文章列表
            </a>

            <header class="mt-8 rounded-3xl border border-zinc-200/80 bg-white p-6 sm:p-8 dark:border-zinc-700 dark:bg-zinc-900">
              <div class="flex flex-wrap items-center gap-3 text-xs text-zinc-500 dark:text-zinc-400">
                <time datetime={date.toISOString()}>
                  {date.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </time>
                <span>·</span>
                <span>{author}</span>
              </div>

              <h1 class="mt-4 text-3xl font-bold tracking-tight text-zinc-900 sm:text-4xl dark:text-zinc-100">{title}</h1>
              {subtitle && <p class="mt-4 text-base leading-7 text-zinc-600 dark:text-zinc-300">{subtitle}</p>}

              {tags.length > 0 && (
                <div class="mt-5 flex flex-wrap gap-2">
                  {tags.map((tag) => (
                    <a
                      href={`/tags/${tag}/`}
                      class="rounded-full bg-zinc-100 px-2.5 py-1 text-xs font-medium text-zinc-700 transition hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700"
                    >
                      {tag}
                    </a>
                  ))}
                </div>
              )}
            </header>

            <div class="prose prose-lg prose-zinc mt-8 max-w-none leading-8 dark:prose-invert prose-pre:rounded-2xl prose-img:rounded-2xl">
              <slot />
            </div>
          </div>
        </div>
      </div>
    </article>
  </SpotlightLayout>
)}
