---
import SpotlightLayout from './SpotlightLayout.astro';
import PhotographyLayout from './PhotographyLayout.astro';
import { generateBlogPostStructuredData } from '../utils/seo';

export interface Props {
  title: string;
  subtitle?: string;
  author: string;
  date: Date;
  tags: string[];
  header_img?: string;
  description?: string;
  lang: 'zh' | 'en';
  type?: 'article' | 'photography';
  gallery?: Array<{ src: string; alt?: string; caption?: string; width?: number; height?: number }>;
  camera?: { model?: string; lens?: string; settings?: string };
  location?: string;
  publishedDate?: string;
}

const { title, subtitle, author, date, tags, header_img, description, lang, type = 'article', gallery, camera, location, publishedDate } = Astro.props;

const postUrl = new URL(Astro.url.pathname, Astro.site).toString();
const previewImage = header_img || (type === 'photography' && gallery?.[0]?.src);
const structuredData = generateBlogPostStructuredData({
  title,
  description: description || subtitle,
  author,
  date,
  image: previewImage,
  url: postUrl,
  tags,
  type,
});
---

{type === 'photography' ? (
  <PhotographyLayout
    title={title}
    subtitle={subtitle}
    author={author}
    date={date}
    tags={tags}
    header_img={header_img}
    description={description}
    lang={lang}
    gallery={gallery}
    camera={camera}
    location={location}
    publishedDate={publishedDate}
  >
    <slot />
  </PhotographyLayout>
) : (
  <SpotlightLayout title={`${title} | Joey's Notes`} description={description || subtitle || title} image={previewImage || undefined} lang={lang} structuredData={structuredData}>
    <article class="section-gap">
      <div class="shell">
        <div class="reading-narrow">
          <a href="/articles/" class="text-sm muted hover:text-[var(--text)]">← 返回文章列表</a>

          <header class="mt-8 border-b pb-10" style="border-color: var(--line);">
            <p class="entry-meta">
              {date.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
              · {author}
            </p>
            <h1 class="mt-4 text-4xl font-semibold leading-[1.15] sm:text-5xl">{title}</h1>
            {subtitle && <p class="mt-5 text-lg leading-8 muted">{subtitle}</p>}
          </header>

          <div class="prose prose-lg mt-12">
            <slot />
          </div>

          {tags.length > 0 && (
            <footer class="mt-14 border-t pt-6" style="border-color: var(--line);">
              <div class="flex flex-wrap gap-2">
                {tags.map((tag) => (
                  <a href={`/tags/${tag}/`} class="rounded-full border px-2.5 py-1 text-xs muted hover:text-[var(--text)]" style="border-color: var(--line);">
                    {tag}
                  </a>
                ))}
              </div>
            </footer>
          )}

          <div class="mt-8 flex items-center justify-between border-t pt-6 text-sm" style="border-color: var(--line);">
            <a href="/articles/" class="muted hover:text-[var(--text)]">返回文章列表</a>
            <a href="/tags/" class="muted hover:text-[var(--text)]">浏览全部标签</a>
          </div>
        </div>
      </div>
    </article>
  </SpotlightLayout>
)}
